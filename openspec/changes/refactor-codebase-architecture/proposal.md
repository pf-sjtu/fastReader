# Proposal: 代码库架构重构与优化

## Change ID
`refactor-codebase-architecture`

## Status
ACTIVE

## 1. 背景与动机

基于2026-02-08完成的代码库全面审核，fastReader项目在功能层面已经较为完整，但在架构、性能、代码质量方面存在明显问题：

- **架构问题**: App.tsx 1669行、aiService.ts 1305行、configStore.ts 912行 - 都过于庞大
- **性能问题**: PDF重复读取内存翻倍、串行处理无并发控制
- **代码复用**: 150行重复代码、多处工具函数重复定义
- **测试覆盖**: 仅35%，核心模块缺少测试

**总体评分**: 5.95/10 (需要改进)

## 2. 目标

### 2.1 主要目标
1. 拆分过大文件，提高可维护性
2. 重构服务层，使用策略模式
3. 优化性能，减少内存占用
4. 提升测试覆盖率到80%+

### 2.2 成功指标
| 指标 | 当前 | 目标 |
|-----|------|------|
| 最大文件行数 | 1669行 | <500行 |
| 测试覆盖率 | 35% | >80% |
| 重复代码 | 150行+ | <50行 |
| 架构评分 | 5.2/10 | >8.0/10 |

## 3. 变更范围

### 3.1 包含的变更
- 组件拆分与重构
- 服务层策略模式重构
- Store拆分
- 工具函数提取
- 性能优化
- 测试补充

### 3.2 不包含的变更
- 功能新增
- UI设计改版
- 技术栈更换
- 数据库结构变更

## 4. 影响分析

### 4.1 影响范围
- **高**: src/App.tsx, src/services/aiService.ts, src/stores/configStore.ts
- **中**: src/services/pdfProcessor.ts, src/services/epubProcessor.ts
- **低**: 组件目录结构调整

### 4.2 风险评估
| 风险 | 概率 | 影响 | 缓解措施 |
|-----|------|------|---------|
| 功能回归 | 中 | 高 | 完整测试覆盖、渐进式重构 |
| 性能下降 | 低 | 中 | 性能基准测试 |
| 合并冲突 | 高 | 中 | 快速迭代、频繁合并 |

## 5. 实施策略

### 5.1 阶段划分
1. **阶段1**: 内存安全与BUG修复 (1周)
2. **阶段2**: 架构重构 (2周)
3. **阶段3**: 性能优化 (2周)
4. **阶段4**: 测试补充 (1周)

### 5.2 并行策略
- 多个独立模块可并行重构
- 使用Agent Teams加速开发

## 6. 相关审核报告
- `tmp/audit-reports/01-architecture-modularity.md`
- `tmp/audit-reports/02-code-reuse-filesize.md`
- `tmp/audit-reports/03-hardcoded-config.md`
- `tmp/audit-reports/04-ui-ux-design.md`
- `tmp/audit-reports/05-performance-optimization.md`
- `tmp/audit-reports/06-bugs-testing.md`

## 7. 兼容契约

本重构遵循以下兼容性原则，确保平滑迁移：

### 7.1 行为兼容
- **保持现有UI主流程行为**: 所有用户可见的交互流程、操作步骤、界面响应保持一致
- **保持现有持久化key与核心配置语义**: localStorage中的存储键名、配置项名称、数据结构语义不变
- **迁移失败可回退legacy读取路径**: 如检测到配置迁移异常，自动回退到旧版读取路径，确保用户数据不丢失

### 7.2 数据兼容
- 现有用户配置数据无需手动迁移
- 缓存数据格式保持稳定
- 支持新旧配置格式并存期

## 8. 批准状态

| 角色 | 状态 | 签名 | 日期 |
|-----|------|------|------|
| 技术负责人 | APPROVED | Claude Code | 2026-02-08 |
| 产品经理 | PENDING | | |
| 架构师 | PENDING | | |

---

*Created: 2026-02-08*
*Last Updated: 2026-02-08*
